<!doctype html>
<html lang="ja"><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IMU Minimal on GitHub Pages</title>
<style>
  body{font-family:system-ui,"Noto Sans JP",sans-serif;margin:20px;line-height:1.6}
  .row{margin:10px 0}
  code{display:inline-block;min-width:240px;background:#f5f5f7;padding:4px 8px;border-radius:6px}
  .ok{color:#0a7} .warn{color:#c80} .bad{color:#d33}
  button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#fff}
</style>
<body>
<h2>センサー確認デモ（GitHub Pages 用）</h2>

<div class="row">状態: <span id="state">init...</span></div>
<div class="row"><button id="perm">📡 センサー許可</button></div>

<div class="row"><b>DeviceMotion:</b> <code id="dm">待機中</code></div>
<div class="row"><b>Orientation:</b> <code id="do">待機中</code></div>

<div class="row"><b>Generic Sensor API (Accel):</b> <code id="ga">未使用</code></div>
<div class="row"><b>Generic Sensor API (Gyro):</b> <code id="gg">未使用</code></div>

<script>
const $ = (id)=>document.getElementById(id);
const secure = window.isSecureContext;
const hasDM = 'DeviceMotionEvent' in window;
const hasDO = 'DeviceOrientationEvent' in window;
const hasGS = 'Accelerometer' in window || 'Gyroscope' in window;

function setState(msg, cls=''){ const el=$('state'); el.textContent=msg; el.className=cls; }
function fmt(n){ return (n==null?0:n).toFixed(3); }

setState(`secure=${secure} / DM=${hasDM} / DO=${hasDO} / GS=${hasGS}`, secure?'ok':'bad');

let dmCount=0, doCount=0, gaCount=0, ggCount=0;

function attachLegacy(){
  // DeviceMotion / DeviceOrientation
  window.addEventListener('devicemotion', e=>{
    dmCount++;
    const a = e.accelerationIncludingGravity || e.acceleration || {};
    $('dm').textContent = `#${dmCount} ax=${fmt(a.x)} ay=${fmt(a.y)} az=${fmt(a.z)}`;
  }, {passive:true});
  window.addEventListener('deviceorientation', e=>{
    doCount++;
    $('do').textContent = `#${doCount} yaw=${fmt(e.alpha)} pitch=${fmt(e.beta)} roll=${fmt(e.gamma)}`;
  }, {passive:true});
}

async function attachGeneric(){
  try{
    if('Accelerometer' in window){
      const acc = new Accelerometer({frequency:30}); // 30Hz程度
      acc.addEventListener('reading', ()=>{
        gaCount++;
        $('ga').textContent = `#${gaCount} ax=${fmt(acc.x)} ay=${fmt(acc.y)} az=${fmt(acc.z)}`;
      });
      acc.start();
    } else {
      $('ga').textContent = '未対応';
    }
    if('Gyroscope' in window){
      const gyro = new Gyroscope({frequency:30});
      gyro.addEventListener('reading', ()=>{
        ggCount++;
        $('gg').textContent = `#${ggCount} gx=${fmt(gyro.x)} gy=${fmt(gyro.y)} gz=${fmt(gyro.z)}`;
      });
      gyro.start();
    } else {
      $('gg').textContent = '未対応';
    }
  }catch(e){
    $('ga').textContent = 'エラー: '+e.message;
    $('gg').textContent = 'エラー: '+e.message;
  }
}

$('perm').onclick = async ()=>{
  // iOS の requestPermission（タップ起点が必須）
  try{
    if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
      const st = await DeviceMotionEvent.requestPermission();
      if(st !== 'granted') throw new Error('DeviceMotion 拒否');
    }
    if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
      await DeviceOrientationEvent.requestPermission().catch(()=>{});
    }
  }catch(e){
    setState('iOS 権限が拒否されました: '+e.message, 'bad');
  }

  // 旧API (Safari/Chrome端末依存)
  if(hasDM || hasDO) attachLegacy();

  // Generic Sensor API（Android Chrome で動くことが多い / iOS Safariは未対応）
  if(hasGS) attachGeneric();

  setState('リスナー登録完了：端末を少し動かしてみてください', 'ok');
};

// 初期チェック
if(!secure){
  setState('非HTTPSなのでセンサーがブロックされます（GitHub PagesはHTTPSなので、この表示が出てたら別の経路で開いている可能性）', 'bad');
}
</script>
</body>
